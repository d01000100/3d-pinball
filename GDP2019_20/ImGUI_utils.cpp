#include "ImGUI_utils.h"
#include "imgui/imgui.h"
#include "imgui/imgui_impl_glfw.h"
#include "imgui/imgui_impl_opengl3.h"
#include <glm/vec3.hpp>
#include <iostream>
#include "Pinball.h"

/*
 * Esto esta aqui mientras porque no puedo incluir tools y
 * no se donde ponerlo
 */
bool jsonContains(nlohmann::json object, std::string key)
{
	return object.find(key) != object.end();
}

vJSON ImGUI_utils::jsonsToDisplay;
GLFWwindow* ImGUI_utils::window;

void ImGUI_utils::init(GLFWwindow *window)
{
	ImGUI_utils::window = window;
	IMGUI_CHECKVERSION();
	ImGui::CreateContext();
	ImGuiIO& io = ImGui::GetIO(); (void)io;
	//io.ConfigFlags |= ImGuiConfigFlags_NavEnableKeyboard;     // Enable Keyboard Controls
	//io.ConfigFlags |= ImGuiConfigFlags_NavEnableGamepad;      // Enable Gamepad Controls

	// Setup Dear ImGui style
	ImGui::StyleColorsDark();

	io.Fonts->AddFontFromFileTTF("./assets/fonts/dejavu/DejaVuSans.ttf", 30.0f);

	// Setup Platform/Renderer bindings
	ImGui_ImplGlfw_InitForOpenGL(window, true);
	ImGui_ImplOpenGL3_Init("#version 420");
}

bool show_demo_window = true,
	show_another_window = false;
glm::vec3 color(1.0, 0.4, 0.0);



void ImGUI_utils::render()
{
	ImGui_ImplOpenGL3_NewFrame();
	ImGui_ImplGlfw_NewFrame();
	ImGui::NewFrame();

	//ImGui::ShowDemoWindow();

	// Everything has to be called for render each frame and on this "context"
	// So that's why there's a function to add jsons to render and another
	// function to actually render them

	// Render jsons info
	for (auto &data : jsonsToDisplay)
	{
		renderJSON(data);
	}
	jsonsToDisplay.clear();

	renderMenu();

	ImGui::Render();
	ImGui_ImplOpenGL3_RenderDrawData(ImGui::GetDrawData());
}

void ImGUI_utils::displayJSON(nlohmann::json data)
{
	jsonsToDisplay.push_back(data);
}

void ImGUI_utils::renderJSON(nlohmann::json data)
{
	if (!data.is_object()) return;

	int flags = ImGuiWindowFlags_NoResize | ImGuiWindowFlags_NoMove;

	if (jsonContains(data, "title"))
	{
		ImGui::Begin(data["title"].get<std::string>().c_str(), nullptr, flags);
		data.erase("title");
	}
	else
	{
		ImGui::Begin("the title is a lie", nullptr, flags | ImGuiWindowFlags_NoTitleBar);
	}
	
	if (jsonContains(data, "pos"))
	{
		ImGui::SetWindowPos(ImVec2(data["pos"][0], data["pos"][1]));
		data.erase("pos");
	}

	if (jsonContains(data, "size"))
	{
		ImGui::SetWindowSize(ImVec2(data["size"][0], data["size"][1]));
		data.erase("size");
	}

	for (auto& key_value : data.items())
	{
		auto entry = key_value.value();
		ImGui::TextColored(ImVec4(1, 1, 0, 1), key_value.key().c_str());
		ImGui::SameLine(0, 20);
		if (entry.is_string())
		{
			ImGui::Text(key_value.value().get<std::string>().c_str());
		}
		if (entry.is_number_integer())
		{
			ImGui::Text(std::to_string(key_value.value().get<int>()).c_str());
		}
		if (entry.is_number_float())
		{
			ImGui::Text(std::to_string(key_value.value().get<float>()).c_str());
		}
	}

	ImGui::End();
}

void ImGUI_utils::renderMenu()
{
	int flags = ImGuiWindowFlags_NoTitleBar;
	ImGui::Begin("Game Ingo", nullptr, flags);

	ImGui::TextColored(ImVec4(1, 1, 0, 1), "Points:");
	ImGui::SameLine(0, 20);
	ImGui::Text(std::to_string(Pinball::points).c_str());

	ImGui::TextColored(ImVec4(1, 1, 0, 1), "Lives left:");
	ImGui::SameLine(0, 20);
	ImGui::Text(std::to_string(Pinball::lives).c_str());
	
	ImGui::End();
}
